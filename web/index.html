<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY COOLEST CAR</title>
    <style>
        .container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            
        }
        .row{
            display: flex;
            margin: 10px 0 0 0;
        }
        .col{
            flex: 1;            
        }
        .col-3 {
            flex: 0 0 25%;
        }
        .col-6 {
            flex: 0 0 50%;
        }
        .col-9 {
            flex: 0 0 75%;
        }

    </style>
</head>
<body>
    <h1>MY COOLEST CAR</h1>
    <div>
        <input type="text" id="wsServerIP" value="192.168.1.225">
        <div id="wsStatus" style="margin-bottom:8px;color:#007700;font-weight:bold;">
    Đang kiểm tra trạng thái WebSocket...
</div>
        <input type="button" id="wsConnectBtn" value="Connect WebSocket" onclick="ws_retryConnect()">
    </div>
    <div class="container">
        <div style="margin-top:10px;">
            <label>Tốc độ M1:</label>
            <input type="range" id="M1_speed" value="0" min="0" max="100" style="width:180px;">
            <span id="M1_speed_display">0</span>
            <br>
            <label>Tốc độ M2:</label>
            <input type="range" id="M2_speed" value="0" min="0" max="100" style="width:180px;">
            <span id="M2_speed_display">0</span>
            <br> 
            <div style="margin-top:16px;">
                <label style="margin-top: 50px;" for="motor_sync">Đồng bộ</label>
                <input type="checkbox" id="motor_sync" checked>        
            </div>
        </div>
        <div>
            <input type="button" style="color: rgb(248, 253, 248); background-color: rgb(6, 137, 6); margin: 10px;" onclick="runMotor()" value="RUN">
        </div>
        <div>
            <h2>Robot Status</h2>
            <div id="robotStatus">
                <p>Line: <span id="linePosition">00000</span></p>
                <p>Segment Type: <span id="segmentType">unknown</span></p>
                <p>Line Pos: <span id="linePosValue">0.000</span></p>
                <p>PID: <span id="pidValue">[0,0,0.000,0.000,0.000]</span></p>
            </div>
        </div>
    </div>
    <!-- Thêm vào phần body -->
    <div class="container">
        <h3>Cấu hình Stage</h3>
        <form id="stageForm">
            <label>Stage:</label>
            <input type="number" id="stageIndex" value="0" min="0"><br><br>
            <div id="segmentContainer"></div>
            <button type="button" onclick="segmentModal_open()">Thêm Segment</button>
        </form>
        <button type="button" onclick="saveSetting()">Lưu Stage</button>

    </div>
    <!-- Modal nhập segment -->
    <div id="segmentModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;z-index:1000;">
        <div style="background:#fff;padding:20px;border-radius:8px;min-width:320px;max-width:90vw;">
            <h3>Thêm Segment</h3>
            <!-- chọn type -->
            <div>
                <label>Type:</label>
                <select id="modal-type" class="type">
                    <option value="straight">Straight</option>
                    <option value="square">Square</option>
                    <option value="curve">Curve</option>
                </select>
            </div>
            <!-- chọn pattern cho loại đường đi -->
            <div style="margin-top:10px;">
                <label>Pattern (cách nhau bởi dấu phẩy):</label>
                <input class="pattern" type="text" id="modal-pattern" value="00100,01100,00110" style="width:90%">
            </div>
            <!-- chọn tốc độ -->
            <div style="margin-top:10px;">
                <label>Tốc độ M1:</label>
                <input type="range" class="modal-M1-speed" id="modal-M1" value="0" min="0" max="100" style="width:180px;"> 
                <span id="M1_display">0</span>
                <br>
                <label>Tốc độ M2:</label>
                <input type="range" id="modal-M2" class="modal-M2-speed" value="0" min="0" max="100" style="width:180px;">
                <span id="M2_display">0</span>
                 <br>
                 <div style="margin-top:16px;">
                    <label  for="modal-sync">Đồng bộ</label>
                    <input type="checkbox" id="modal-sync" checked>
                 </div>
                
            </div>
            <!-- chọn pid -->
        <div style="margin-top:16px;">
            <label>Time each Type</label>
            <input id="modal-time" class="type-time" type="number" step="1" value="0" style="width:60px;">
        </div>
        <div style="margin-top:16px;">
            <label>PID (Kp, Ki, Kd):</label>
            <input id="modal-Kp" class="type-kp" type="number" step="0.01" value="0" style="width:60px;">
            <input id="modal-Ki" class="type-ki" type="number" step="0.01" value="0" style="width:60px;">
            <input id="modal-Kd" class="type-kd" type="number" step="0.01" value="0" style="width:60px;">
        </div>
            <div style="margin-top:16px;text-align:right;">
                <button type="button" onclick="segmentModal_submit()">Thêm</button>
                <button type="button" onclick="segmentModal_close()">Đóng</button>
            </div>
        </div>
    </div>
</body>

<script>

    function runMotor() {
        const M1 = parseFloat(document.getElementById('M1_speed').value);
        const M2 = parseFloat(document.getElementById('M2_speed').value);
        const motor_sync = document.getElementById('motor_sync').checked;
        const stageConfigs = [
            {
                stage: 0,
                segments: [
                    {
                        type: "straight",
                        pattern: ["00100"],
                        pid: [motor_sync ? M1 : M1, motor_sync ? M1 : M2, 0, 0, 0],
                        time: 0
                    }
                ]
            }
        ];
        console.log('Stage configs:', JSON.stringify(stageConfigs, null, 2));
        ws.send(JSON.stringify(stageConfigs));
    }
    document.getElementById('M1_speed').addEventListener('input', function() {
        document.getElementById('M1_speed_display').textContent = this.value;
        if (document.getElementById('motor_sync').checked) {
            document.getElementById('M2_speed').value = this.value;
            document.getElementById('M2_speed_display').textContent = this.value;
        }
    });
    document.getElementById('M2_speed').addEventListener('input', function() {
        document.getElementById('M2_speed_display').textContent = this.value;
    });
    document.getElementById('motor_sync').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('M2_speed').value = document.getElementById('M1_speed').value;
            document.getElementById('M2_speed_display').textContent = document.getElementById('M1_speed').value;
        }
    });
</script>
<script>
    function segmentModal_open() {
        document.getElementById('segmentModal').style.display = 'flex';
    }

    function segmentModal_close() {
        document.getElementById('segmentModal').style.display = 'none';
    }

// Khi nhấn "Thêm" trong modal
function segmentModal_submit() {
    const segmentContainer = document.getElementById('segmentContainer');
    const type = document.getElementById('modal-type').value;
    const pattern = document.getElementById('modal-pattern').value.split(',').map(s => s.trim());
    const Kp = parseFloat(document.getElementById('modal-Kp').value);
    const Ki = parseFloat(document.getElementById('modal-Ki').value);
    const Kd = parseFloat(document.getElementById('modal-Kd').value);
    const time = parseInt(document.getElementById('modal-time').value, 10);
    // Tạo card segment
    const segmentDiv = document.createElement('div');
    segmentDiv.className = 'segment segment-card';
    segmentDiv.dataset.type = type;
    segmentDiv.dataset.pattern = JSON.stringify(pattern);
    segmentDiv.innerHTML = `
        <hr>
        <strong class="type">Type: ${type}</strong><br>
        <strong class="pattern">Dạng </strong>
        <span>${pattern.join(', ')}</span><br>
        <strong>Tốc độ:</strong> 
        <span class="m1-speed">${document.getElementById('modal-M1').value}</span>, 
        <span class="m2-speed">${document.getElementById('modal-M2').value}</span><br>
        <strong>PID:</strong>
        <span class="pid-kp">${Kp}</span>,
        <span class="pid-ki">${Ki}</span>,
        <span class="pid-kd">${Kd}</span><br>
        <strong>Time:</strong>
        <span class="type-time">${time}</span><br>
        <button class="remove-segment-btn" style="float:right;">X</button>
    `;
    segmentContainer.appendChild(segmentDiv);

    // Xử lý nút xóa
    segmentDiv.querySelector('.remove-segment-btn').onclick = function() {
        segmentDiv.remove();
    };

    segmentModal_close();
}

document.getElementById('modal-M1').addEventListener('input', function() {
        document.getElementById('M1_display').textContent = this.value;
        if (document.getElementById('modal-sync').checked) {
            document.getElementById('modal-M2').value = this.value;
            document.getElementById('M2_display').textContent = this.value;
        }
    });
    document.getElementById('modal-M2').addEventListener('input', function() {
        document.getElementById('M2_display').textContent = this.value;
    });
    document.getElementById('modal-sync').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('modal-M2').value = document.getElementById('modal-M1').value;
            document.getElementById('M2_display').textContent = document.getElementById('modal-M1').value;
        }
    });

function saveSetting() {
    const stageIndex = parseInt(document.getElementById('stageIndex').value);
    const segments = [];
    document.querySelectorAll('.segment-card').forEach(card => {
        const typeValue = card.dataset.type; // lấy từ data-type
        const patternArray = JSON.parse(card.dataset.pattern); // lấy từ data-pattern
        const m1 = parseFloat(card.querySelector('.m1-speed').textContent.trim());
        const m2 = parseFloat(card.querySelector('.m2-speed').textContent.trim());
        const kp = parseFloat(card.querySelector('.pid-kp').textContent.trim());
        const ki = parseFloat(card.querySelector('.pid-ki').textContent.trim());
        const kd = parseFloat(card.querySelector('.pid-kd').textContent.trim());
        const time = parseInt(card.querySelector('.type-time').textContent.trim(), 10);
        segments.push({
            type: typeValue,           // đúng: "straight"
            pattern: patternArray,     // đúng: ["00100", "01100"]
            pid: [m1, m2, kp, ki, kd],
            time: time
        });
    });
    const stageConfigs = [
        {
            stage: stageIndex,
            segments: segments
        }
    ];


    if (ws && ws.readyState === WebSocket.OPEN) {
        console.log('Sending ', stageConfigs);
        ws.send(JSON.stringify(stageConfigs));
    } else {
        alert('WebSocket chưa kết nối!');
    }
}
</script>
<script>
    window.onload = function() {
        initWebSocket();
    };

    let ws = null; // Khai báo ở đầu file script

function messageDispatcher(data) {
    let line = 'No data', segment = 'unknown', pid = '[0,0,0,0,0]', linePos = '0.000';
    if (Array.isArray(data)) {
        data.forEach(item => {
            if (item.cmd === "sensor") line = item.value;
            if (item.cmd === "SegmentType") segment = item.value;
            if (item.cmd === "pid") pid = JSON.stringify(item.value);
            if (item.cmd === "linePos") linePos = item.value;
        });
    } else {
        if (data.sensor) line = data.sensor;
        if (data.SegmentType) segment = data.SegmentType;
        if (data.pid) pid = JSON.stringify(data.pid);
        if (data.linePos) linePos = data.linePos;
    }
    document.getElementById('linePosition').textContent = line;
    document.getElementById('segmentType').textContent = segment;
    document.getElementById('pidValue').textContent = pid;
    document.getElementById('linePosValue').textContent = linePos;
}
function updateWsStatus(text, color = "#007700") {
    const statusDiv = document.getElementById('wsStatus');
    statusDiv.textContent = text;
    statusDiv.style.color = color;
}


    function initWebSocket() {
        if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
            ws.close();
        }
        const wsServerIP = document.getElementById('wsServerIP').value;
        const wsUrl = `ws://${wsServerIP}/ws`;
        ws = new WebSocket(wsUrl);
        updateWsStatus("Đang kết nối...", "#888800");

        ws.onopen = function() {
            updateWsStatus("Đã kết nối WebSocket!", "#007700");
        };
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                messageDispatcher(data);
            } catch (e) {
                console.error("Invalid JSON", e);
            }
        };
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            updateWsStatus("Lỗi WebSocket!", "#aa0000");
        };
        ws.onclose = function() {
            updateWsStatus("WebSocket đã đóng!", "#aa0000");
            setTimeout(initWebSocket, 5000); // Retry connection after 5 seconds
        };
    }
    function ws_retryConnect() {
        initWebSocket();
    }
</script>
</html>